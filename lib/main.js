"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core = require("@actions/core");
const exec_1 = require("@actions/exec");
const inputs_1 = require("./inputs");
async function run() {
    core.debug(':: Loading input params');
    const inputs = new inputs_1.default();
    const accountUrl = `${inputs.AwsAccountID}.dkr.ecr.${inputs.Region}.amazonaws.com`;
    // Configure AWS CLI
    awsConfigure(inputs);
    // Login to AWS ECR
    await awsEcrLogin(inputs);
    // Create ECR Repo
    await awsCreateEcrRepo(inputs);
    // Build the Dockerfile image
    await buildImage(inputs, accountUrl);
    // Deploy built image tags to AWS ECR
    await deployToEcr(inputs, accountUrl);
}
function awsConfigure(inputs) {
    core.debug(':: Setting AWS credentials');
    core.exportVariable('AWS_ACCESS_KEY_ID', inputs.AccessKeyID);
    core.exportVariable('AWS_SECRET_ACCESS_KEY', inputs.SecretAccessKey);
    core.exportVariable('AWS_DEFAULT_REGION', inputs.Region);
}
async function awsEcrLogin(inputs) {
    core.info('== LOGIN INTO AWS ECR ==');
    let loginCmd = '';
    let err = '';
    let opts = {
        cwd: './',
        silent: true,
        listeners: {
            stdout: (data) => {
                loginCmd += data.toString();
            },
            stderr: (data) => {
                err += data.toString();
            }
        },
    };
    await exec_1.exec(`aws ecr get-login --no-include-email --region ${inputs.Region}`, undefined, opts);
    if (err.length > 0) {
        throw new Error('Failed to retrieve docker login to AWS ECR. Perhaps the AWS credentials do not have the correct permission');
    }
    await exec_1.exec(loginCmd, undefined, opts);
    core.info('== FINISHED LOGIN ==');
}
function getEcrRepoName(inputs) {
    if (inputs.EcrRepoName.length > 0) {
        return inputs.EcrRepoName;
    }
    // default
    return (process.env.GITHUB_REPOSITORY || '').toLocaleLowerCase();
}
function getEcrTags(accountUrl, repoName, inputTags) {
    let tags = inputTags.split(',');
    const ecrTags = [];
    // Add the ref tag if code is a checked out release tag
    if ((process.env.GITHUB_REF || '').startsWith('refs/tags')) {
        const tag = (process.env.GITHUB_REF || '').split('/').pop();
        if (tag !== '' || tag !== undefined) {
            ecrTags.push(`${accountUrl}/${repoName}:${tag}`);
        }
    }
    // Build the tags
    for (const tag of tags) {
        ecrTags.push(`${accountUrl}/${repoName}:${tag}`);
    }
    return ecrTags;
}
async function awsCreateEcrRepo(inputs) {
    core.info('== CHECKING FOR ECR REPO ==');
    const repoName = getEcrRepoName(inputs);
    let output = '';
    let err = '';
    let opts = {
        cwd: './',
        silent: true,
        listeners: {
            stdout: (data) => {
                output += data.toString();
            },
            stderr: (data) => {
                err += data.toString();
            }
        },
    };
    await exec_1.exec(`aws ecr describe-repositories --repository-names "${repoName}"`, undefined, opts);
    if (err.length > 0) {
        // Repo doesn't exist or failed. Try creating...
        await exec_1.exec(`aws ecr create-repository --repository-name ${repoName}`);
        core.info(`== CREATED ECR REPO [ ${repoName} ] ==`);
        return;
    }
    core.info('== REPO FOUND ==');
}
async function buildImage(inputs, accountUrl) {
    core.info('== BUILD IMAGE FROM DOCKERFILE ==');
    const repoName = getEcrRepoName(inputs);
    const ecrTags = getEcrTags(accountUrl, repoName, inputs.EcrTags);
    let tags = ecrTags.join(' -t ');
    if (tags.length > 0) {
        tags = `-t ${tags}`;
    }
    await exec_1.exec(`docker build ${inputs.DockerBuildArgs} -f ${inputs.DockerfilePath} ${tags} .`, undefined, {
        cwd: inputs.ProjectPath,
    });
    core.info('== FINISHED BUILDING IMAGE ==');
}
async function deployToEcr(inputs, accountUrl) {
    core.info('== DEPLOYING TO ECR ==');
    core.debug(`:: ECR Account URL: ${accountUrl}`);
    const repoName = getEcrRepoName(inputs);
    const ecrTags = getEcrTags(accountUrl, repoName, inputs.EcrTags);
    for (const tag of ecrTags) {
        await exec_1.exec(`docker push ${tag}`);
    }
    core.info('== FINISHED DEPLOYMENT ==');
}
try {
    run();
}
catch (error) {
    core.error(error);
    core.setFailed(error.message);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQXNDO0FBQ3RDLHdDQUFxQztBQUVyQyxxQ0FBOEI7QUFFOUIsS0FBSyxVQUFVLEdBQUc7SUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBQ3RDLE1BQU0sTUFBTSxHQUFHLElBQUksZ0JBQU0sRUFBRSxDQUFDO0lBRTVCLE1BQU0sVUFBVSxHQUFHLEdBQUcsTUFBTSxDQUFDLFlBQVksWUFBWSxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsQ0FBQztJQUVuRixvQkFBb0I7SUFDcEIsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXJCLG1CQUFtQjtJQUNuQixNQUFNLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUUxQixrQkFBa0I7SUFDbEIsTUFBTSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUUvQiw2QkFBNkI7SUFDN0IsTUFBTSxVQUFVLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBRXJDLHFDQUFxQztJQUNyQyxNQUFNLFdBQVcsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDeEMsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLE1BQWM7SUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFBO0lBQ3hDLElBQUksQ0FBQyxjQUFjLENBQUMsbUJBQW1CLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzdELElBQUksQ0FBQyxjQUFjLENBQUMsdUJBQXVCLEVBQUUsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3JFLElBQUksQ0FBQyxjQUFjLENBQUMsb0JBQW9CLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNELENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLE1BQWM7SUFDdkMsSUFBSSxD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Q0FBQyxDQUFDO0lBQ0gsSUFBSSxDQUFDLElBQUksQ0FBQywrQkFBK0IsQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLE1BQWMsRUFBRSxVQUFrQjtJQUMzRCxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLENBQUM7SUFDcEMsSUFBSSxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUVoRCxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDeEMsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLFVBQVUsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRWpFLEtBQUssTUFBTSxHQUFHLElBQUksT0FBTyxFQUFFO1FBQ3pCLE1BQU0sV0FBSSxDQUFDLGVBQWUsR0FBRyxFQUFFLENBQUMsQ0FBQztLQUNsQztJQUVELElBQUksQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBRUQsSUFBSTtJQUNGLEdBQUcsRUFBRSxDQUFDO0NBQ1A7QUFBQyxPQUFPLEtBQUssRUFBRTtJQUNkLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7Q0FDL0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBjb3JlIGZyb20gJ0BhY3Rpb25zL2NvcmUnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ0BhY3Rpb25zL2V4ZWMnO1xuaW1wb3J0IHsgRXhlY09wdGlvbnMgfSBmcm9tICdAYWN0aW9ucy9leGVjL2xpYi9pbnRlcmZhY2VzJztcbmltcG9ydCBJbnB1dHMgZnJvbSAnLi9pbnB1dHMnO1xuXG5hc3luYyBmdW5jdGlvbiBydW4oKSB7XG4gIGNvcmUuZGVidWcoJzo6IExvYWRpbmcgaW5wdXQgcGFyYW1zJyk7XG4gIGNvbnN0IGlucHV0cyA9IG5ldyBJbnB1dHMoKTtcblxuICBjb25zdCBhY2NvdW50VXJsID0gYCR7aW5wdXRzLkF3c0FjY291bnRJRH0uZGtyLmVjci4ke2lucHV0cy5SZWdpb259LmFtYXpvbmF3cy5jb21gO1xuXG4gIC8vIENvbmZpZ3VyZSBBV1MgQ0xJXG4gIGF3c0NvbmZpZ3VyZShpbnB1dHMpO1xuXG4gIC8vIExvZ2luIHRvIEFXUyBFQ1JcbiAgYXdhaXQgYXdzRWNyTG9naW4oaW5wdXRzKTtcblxuICAvLyBDcmVhdGUgRUNSIFJlcG9cbiAgYXdhaXQgYXdzQ3JlYXRlRWNyUmVwbyhpbnB1dHMpO1xuXG4gIC8vIEJ1aWxkIHRoZSBEb2NrZXJmaWxlIGltYWdlXG4gIGF3YWl0IGJ1aWxkSW1hZ2UoaW5wdXRzLCBhY2NvdW50VXJsKTtcblxuICAvLyBEZXBsb3kgYnVpbHQgaW1hZ2UgdGFncyB0byBBV1MgRUNSXG4gIGF3YWl0IGRlcGxveVRvRWNyKGlucHV0cywgYWNjb3VudFVybCk7XG59XG5cbmZ1bmN0aW9uIGF3c0NvbmZpZ3VyZShpbnB1dHM6IElucHV0cykge1xuICBjb3JlLmRlYnVnKCc6OiBTZXR0aW5nIEFXUyBjcmVkZW50aWFscycpXG4gIGNvcmUuZXhwb3J0VmFyaWFibGUoJ0FXU19BQ0NFU1NfS0VZX0lEJywgaW5wdXRzLkFjY2Vzc0tleUlEKTtcbiAgY29yZS5leHBvcnRWYXJpYWJsZSgnQVdTX1NFQ1JFVF9BQ0NFU1NfS0VZJywgaW5wdXRzLlNlY3JldEFjY2Vzc0tleSk7XG4gIGNvcmUuZXhwb3J0VmFyaWFibGUoJ0FXU19ERUZBVUxUX1JFR0lPTicsIGlucHV0cy5SZWdpb24pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBhd3NFY3JMb2dpbihpbnB1dHM6IElucHV0cykge1xuICBjb3JlLmluZm8oJz09IExPR0lOIElOVE8gQVdTIEVDUiA9PScpXG5cbiAgbGV0IGxvZ2luQ21kID0gJyc7XG4gIGxldCBlcnIgPSAnJztcblxuICBsZXQgb3B0czogRXhlY09wdGlvbnMgPSB7XG4gICAgY3dkOiAnLi8nLFxuICAgIHNpbGVudDogdHJ1ZSxcbiAgICBsaXN0ZW5lcnM6IHtcbiAgICAgIHN0ZG91dDogKGRhdGE6IEJ1ZmZlcikgPT4ge1xuICAgICAgICBsb2dpbkNtZCArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICB9LFxuICAgICAgc3RkZXJyOiAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICAgIGVyciArPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgICB9XG4gICAgfSxcbiAgfVxuXG4gIGF3YWl0IGV4ZWMoYGF3cyBlY3IgZ2V0LWxvZ2luIC0tbm8taW5jbHVkZS1lbWFpbCAtLXJlZ2lvbiAke2lucHV0cy5SZWdpb259YCwgdW5kZWZpbmVkLCBvcHRzKTtcbiAgaWYgKGVyci5sZW5ndGggPiAwKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdGYWlsZWQgdG8gcmV0cmlldmUgZG9ja2VyIGxvZ2luIHRvIEFXUyBFQ1IuIFBlcmhhcHMgdGhlIEFXUyBjcmVkZW50aWFscyBkbyBub3QgaGF2ZSB0aGUgY29ycmVjdCBwZXJtaXNzaW9uJyk7XG4gIH1cblxuICBhd2FpdCBleGVjKGxvZ2luQ21kLCB1bmRlZmluZWQsIG9wdHMpO1xuXG4gIGNvcmUuaW5mbygnPT0gRklOSVNIRUQgTE9HSU4gPT0nKTtcbn1cblxuZnVuY3Rpb24gZ2V0RWNyUmVwb05hbWUoaW5wdXRzOiBJbnB1dHMpOiBzdHJpbmcge1xuICBpZiAoaW5wdXRzLkVjclJlcG9OYW1lLmxlbmd0aCA+IDApIHtcbiAgICByZXR1cm4gaW5wdXRzLkVjclJlcG9OYW1lO1xuICB9XG5cbiAgLy8gZGVmYXVsdFxuICByZXR1cm4gKHByb2Nlc3MuZW52LkdJVEhVQl9SRVBPU0lUT1JZIHx8ICcnKS50b0xvY2FsZUxvd2VyQ2FzZSgpXG59XG5cbmZ1bmN0aW9uIGdldEVjclRhZ3MoYWNjb3VudFVybDogc3RyaW5nLCByZXBvTmFtZTogc3RyaW5nLCBpbnB1dFRhZ3M6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgbGV0IHRhZ3MgPSBpbnB1dFRhZ3Muc3BsaXQoJywnKTtcbiAgY29uc3QgZWNyVGFnczogc3RyaW5nW10gPSBbXTtcblxuICAvLyBBZGQgdGhlIHJlZiB0YWcgaWYgY29kZSBpcyBhIGNoZWNrZWQgb3V0IHJlbGVhc2UgdGFnXG4gIGlmICgocHJvY2Vzcy5lbnYuR0lUSFVCX1JFRiB8fCAnJykuc3RhcnRzV2l0aCgncmVmcy90YWdzJykpIHtcbiAgICBjb25zdCB0YWcgPSAocHJvY2Vzcy5lbnYuR0lUSFVCX1JFRiB8fCAnJykuc3BsaXQoJy8nKS5wb3AoKTtcblxuICAgIGlmICh0YWcgIT09ICcnIHx8IHRhZyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBlY3JUYWdzLnB1c2goYCR7YWNjb3VudFVybH0vJHtyZXBvTmFtZX06JHt0YWd9YCk7XG4gICAgfVxuICB9XG5cbiAgLy8gQnVpbGQgdGhlIHRhZ3NcbiAgZm9yIChjb25zdCB0YWcgb2YgdGFncykge1xuICAgIGVjclRhZ3MucHVzaChgJHthY2NvdW50VXJsfS8ke3JlcG9OYW1lfToke3RhZ31gKTtcbiAgfVxuXG4gIHJldHVybiBlY3JUYWdzXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGF3c0NyZWF0ZUVjclJlcG8oaW5wdXRzOiBJbnB1dHMpIHtcbiAgY29yZS5pbmZvKCc9PSBDSEVDS0lORyBGT1IgRUNSIFJFUE8gPT0nKTtcblxuICBjb25zdCByZXBvTmFtZSA9IGdldEVjclJlcG9OYW1lKGlucHV0cyk7XG5cbiAgbGV0IG91dHB1dCA9ICcnO1xuICBsZXQgZXJyID0gJyc7XG5cbiAgbGV0IG9wdHM6IEV4ZWNPcHRpb25zID0ge1xuICAgIGN3ZDogJy4vJyxcbiAgICBzaWxlbnQ6IHRydWUsXG4gICAgbGlzdGVuZXJzOiB7XG4gICAgICBzdGRvdXQ6IChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgb3V0cHV0ICs9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgIH0sXG4gICAgICBzdGRlcnI6IChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgZXJyICs9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgIH1cbiAgICB9LFxuICB9XG5cbiAgYXdhaXQgZXhlYyhgYXdzIGVjciBkZXNjcmliZS1yZXBvc2l0b3JpZXMgLS1yZXBvc2l0b3J5LW5hbWVzIFwiJHtyZXBvTmFtZX1cImAsIHVuZGVmaW5lZCwgb3B0cyk7XG5cbiAgaWYgKGVyci5sZW5ndGggPiAwKSB7XG4gICAgLy8gUmVwbyBkb2Vzbid0IGV4aXN0IG9yIGZhaWxlZC4gVHJ5IGNyZWF0aW5nLi4uXG4gICAgYXdhaXQgZXhlYyhgYXdzIGVjciBjcmVhdGUtcmVwb3NpdG9yeSAtLXJlcG9zaXRvcnktbmFtZSAke3JlcG9OYW1lfWApO1xuICAgIGNvcmUuaW5mbyhgPT0gQ1JFQVRFRCBFQ1IgUkVQTyBbICR7cmVwb05hbWV9IF0gPT1gKTtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGNvcmUuaW5mbygnPT0gUkVQTyBGT1VORCA9PScpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIGJ1aWxkSW1hZ2UoaW5wdXRzOiBJbnB1dHMsIGFjY291bnRVcmw6IHN0cmluZykge1xuICBjb3JlLmluZm8oJz09IEJVSUxEIElNQUdFIEZST00gRE9DS0VSRklMRSA9PScpO1xuICBjb25zdCByZXBvTmFtZSA9IGdldEVjclJlcG9OYW1lKGlucHV0cyk7XG4gIGNvbnN0IGVjclRhZ3MgPSBnZXRFY3JUYWdzKGFjY291bnRVcmwsIHJlcG9OYW1lLCBpbnB1dHMuRWNyVGFncyk7XG5cbiAgbGV0IHRhZ3MgPSBlY3JUYWdzLmpvaW4oJyAtdCAnKTtcblxuICBpZiAodGFncy5sZW5ndGggPiAwKSB7XG4gICAgdGFncyA9IGAtdCAke3RhZ3N9YFxuICB9XG5cblxuICBhd2FpdCBleGVjKGBkb2NrZXIgYnVpbGQgJHtpbnB1dHMuRG9ja2VyQnVpbGRBcmdzfSAtZiAke2lucHV0cy5Eb2NrZXJmaWxlUGF0aH0gJHt0YWdzfSAuYCwgdW5kZWZpbmVkLCB7XG4gICAgY3dkOiBpbnB1dHMuUHJvamVjdFBhdGgsXG4gIH0pO1xuICBjb3JlLmluZm8oJz09IEZJTklTSEVEIEJVSUxESU5HIElNQUdFID09Jyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlcGxveVRvRWNyKGlucHV0czogSW5wdXRzLCBhY2NvdW50VXJsOiBzdHJpbmcpIHtcbiAgY29yZS5pbmZvKCc9PSBERVBMT1lJTkcgVE8gRUNSID09Jyk7XG4gIGNvcmUuZGVidWcoYDo6IEVDUiBBY2NvdW50IFVSTDogJHthY2NvdW50VXJsfWApO1xuXG4gIGNvbnN0IHJlcG9OYW1lID0gZ2V0RWNyUmVwb05hbWUoaW5wdXRzKTtcbiAgY29uc3QgZWNyVGFncyA9IGdldEVjclRhZ3MoYWNjb3VudFVybCwgcmVwb05hbWUsIGlucHV0cy5FY3JUYWdzKTtcblxuICBmb3IgKGNvbnN0IHRhZyBvZiBlY3JUYWdzKSB7XG4gICAgYXdhaXQgZXhlYyhgZG9ja2VyIHB1c2ggJHt0YWd9YCk7XG4gIH1cblxuICBjb3JlLmluZm8oJz09IEZJTklTSEVEIERFUExPWU1FTlQgPT0nKTtcbn1cblxudHJ5IHtcbiAgcnVuKCk7XG59IGNhdGNoIChlcnJvcikge1xuICBjb3JlLmVycm9yKGVycm9yKTtcbiAgY29yZS5zZXRGYWlsZWQoZXJyb3IubWVzc2FnZSk7XG59Il19