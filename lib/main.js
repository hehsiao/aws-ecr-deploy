"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core = require("@actions/core");
const exec_1 = require("@actions/exec");
const inputs_1 = require("./inputs");
async function run() {
    core.debug(':: Loading input params');
    const inputs = new inputs_1.default();
    const accountUrl = `${inputs.AwsAccountID}.dkr.ecr.${inputs.Region}.amazonaws.com`;
    // Configure AWS CLI
    awsConfigure(inputs);
    // Login to AWS ECR
    await awsEcrLogin(inputs);
    // Create ECR Repo
    await awsCreateEcrRepo(inputs);
    // Build the Dockerfile image
    await buildImage(inputs, accountUrl);
    // Deploy built image tags to AWS ECR
    await deployToEcr(inputs, accountUrl);
}
function awsConfigure(inputs) {
    core.debug(':: Setting AWS credentials');
    core.exportVariable('AWS_ACCESS_KEY_ID', inputs.AccessKeyID);
    core.exportVariable('AWS_SECRET_ACCESS_KEY', inputs.SecretAccessKey);
    core.exportVariable('AWS_DEFAULT_REGION', inputs.Region);
}
async function awsEcrLogin(inputs) {
    core.info('== LOGIN INTO AWS ECR ==');
    let loginCmd = '';
    let err = '';
    let opts = {
        cwd: './',
        silent: true,
        listeners: {
            stdout: (data) => {
                loginCmd += data.toString();
            },
            stderr: (data) => {
                err += data.toString();
            }
        },
    };
    await exec_1.exec(`aws ecr get-login --no-include-email --region ${inputs.Region}`, undefined, opts);
    if (err.length > 0) {
        throw new Error('Failed to retrieve docker login to AWS ECR. Perhaps the AWS credentials do not have the correct permission');
    }
    await exec_1.exec(loginCmd, undefined, opts);
    core.info('== FINISHED LOGIN ==');
}
function getEcrRepoName(inputs) {
    if (inputs.EcrRepoName.length > 0) {
        return inputs.EcrRepoName;
    }
    // default
    return (process.env.GITHUB_REPOSITORY || '').toLocaleLowerCase();
}
function getEcrTags(accountUrl, repoName, inputTags) {
    let tags = inputTags.split(',');
    const ecrTags = [];
    // Add the ref tag if code is a checked out release tag
    if ((process.env.GITHUB_REF || '').startsWith('refs/tags')) {
        const tag = (process.env.GITHUB_REF || '').split('/').pop();
        if (tag !== '' || tag !== undefined) {
            ecrTags.push(`${accountUrl}/${repoName}:${tag}`);
        }
    }
    // Build the tags
    for (const tag of tags) {
        ecrTags.push(`${accountUrl}/${repoName}:${tag}`);
    }
    return ecrTags;
}
async function awsCreateEcrRepo(inputs) {
    core.info('== CHECKING FOR ECR REPO ==');
    const repoName = getEcrRepoName(inputs);
    try {
        await exec_1.exec(`aws ecr describe-repositories --repository-names "${repoName}"`);
    }
    catch (_a) {
        // Repo doesn't exist or failed. Try creating if specified.
        if (inputs.ShouldCreateRepo === 'true') {
            core.info('== CREATING ECR REPO ==');
            await exec_1.exec(`aws ecr create-repository --repository-name ${repoName}`);
            core.info(`== FINISHED CREATING ECR REPO [ ${repoName} ] ==`);
            return;
        }
        else {
            core.setFailed('== ECR Repository is missing ==');
            throw new Error(`ECR repo named [ ${repoName} ] was not found. Perhaps the spelling was incorrect?`);
        }
    }
    core.info('== REPO FOUND ==');
}
async function buildImage(inputs, accountUrl) {
    core.info('== BUILD IMAGE FROM DOCKERFILE ==');
    const repoName = getEcrRepoName(inputs);
    const ecrTags = getEcrTags(accountUrl, repoName, inputs.EcrTags);
    let tags = ecrTags.join(' -t ');
    if (tags.length > 0) {
        tags = `-t ${tags}`;
    }
    await exec_1.exec(`docker build ${inputs.DockerBuildArgs} -f ${inputs.DockerfilePath} ${tags} .`, undefined, {
        cwd: inputs.ProjectPath,
    });
    core.info('== FINISHED BUILDING IMAGE ==');
}
async function deployToEcr(inputs, accountUrl) {
    core.info('== DEPLOYING TO ECR ==');
    core.debug(`:: ECR Account URL: ${accountUrl}`);
    const repoName = getEcrRepoName(inputs);
    const ecrTags = getEcrTags(accountUrl, repoName, inputs.EcrTags);
    for (const tag of ecrTags) {
        await exec_1.exec(`docker push ${tag}`);
    }
    core.info('== FINISHED DEPLOYMENT ==');
}
try {
    run();
}
catch (error) {
    core.error(error);
    core.setFailed(error.message);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQXNDO0FBQ3RDLHdDQUFxQztBQUVyQyxxQ0FBOEI7QUFFOUIsS0FBSyxVQUFVLEdBQUc7SUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBQ3RDLE1BQU0sTUFBTSxHQUFHLElBQUksZ0JBQU0sRUFBRSxDQUFDO0lBRTVCLE1BQU0sVUFBVSxHQUFHLEdBQUcsTUFBTSxDQUFDLFlBQVksWUFBWSxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsQ0FBQztJQUVuRixvQkFBb0I7SUFDcEIsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRXJCLG1CQUFtQjtJQUNuQixNQUFNLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUUxQixrQkFBa0I7SUFDbEIsTUFBTSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUUvQiw2QkFBNkI7SUFDN0IsTUFBTSxVQUFVLENBQUMsTUFBTSxFQUFFLFVBQVUsQ0FBQyxDQUFDO0lBRXJDLHFDQUFxQztJQUNyQyxNQUFNLFdBQVcsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLENBQUM7QUFDeEMsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLE1BQWM7SUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsQ0FBQyxDQUFBO0lBQ3hDLElBQUksQ0FBQyxjQUFjLENBQUMsbUJBQW1CLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQzdELElBQUksQ0FBQyxjQUFjLENBQUMsdUJBQXVCLEVBQUUsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQ3JFLElBQUksQ0FBQyxjQUFjLENBQUMsb0JBQW9CLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNELENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLE1BQWM7SUFDdkMsSUFBSSxD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SyxDQUFDLHVCQUF1QixVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBRWhELE1BQU0sUUFBUSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN4QyxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFakUsS0FBSyxNQUFNLEdBQUcsSUFBSSxPQUFPLEVBQUU7UUFDekIsTUFBTSxXQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0tBQ2xDO0lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ3pDLENBQUM7QUFFRCxJQUFJO0lBQ0YsR0FBRyxFQUFFLENBQUM7Q0FDUDtBQUFDLE9BQU8sS0FBSyxFQUFFO0lBQ2QsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsQixJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztDQUMvQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNvcmUgZnJvbSAnQGFjdGlvbnMvY29yZSc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAnQGFjdGlvbnMvZXhlYyc7XG5pbXBvcnQgeyBFeGVjT3B0aW9ucyB9IGZyb20gJ0BhY3Rpb25zL2V4ZWMvbGliL2ludGVyZmFjZXMnO1xuaW1wb3J0IElucHV0cyBmcm9tICcuL2lucHV0cyc7XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1bigpIHtcbiAgY29yZS5kZWJ1ZygnOjogTG9hZGluZyBpbnB1dCBwYXJhbXMnKTtcbiAgY29uc3QgaW5wdXRzID0gbmV3IElucHV0cygpO1xuXG4gIGNvbnN0IGFjY291bnRVcmwgPSBgJHtpbnB1dHMuQXdzQWNjb3VudElEfS5ka3IuZWNyLiR7aW5wdXRzLlJlZ2lvbn0uYW1hem9uYXdzLmNvbWA7XG5cbiAgLy8gQ29uZmlndXJlIEFXUyBDTElcbiAgYXdzQ29uZmlndXJlKGlucHV0cyk7XG5cbiAgLy8gTG9naW4gdG8gQVdTIEVDUlxuICBhd2FpdCBhd3NFY3JMb2dpbihpbnB1dHMpO1xuXG4gIC8vIENyZWF0ZSBFQ1IgUmVwb1xuICBhd2FpdCBhd3NDcmVhdGVFY3JSZXBvKGlucHV0cyk7XG5cbiAgLy8gQnVpbGQgdGhlIERvY2tlcmZpbGUgaW1hZ2VcbiAgYXdhaXQgYnVpbGRJbWFnZShpbnB1dHMsIGFjY291bnRVcmwpO1xuXG4gIC8vIERlcGxveSBidWlsdCBpbWFnZSB0YWdzIHRvIEFXUyBFQ1JcbiAgYXdhaXQgZGVwbG95VG9FY3IoaW5wdXRzLCBhY2NvdW50VXJsKTtcbn1cblxuZnVuY3Rpb24gYXdzQ29uZmlndXJlKGlucHV0czogSW5wdXRzKSB7XG4gIGNvcmUuZGVidWcoJzo6IFNldHRpbmcgQVdTIGNyZWRlbnRpYWxzJylcbiAgY29yZS5leHBvcnRWYXJpYWJsZSgnQVdTX0FDQ0VTU19LRVlfSUQnLCBpbnB1dHMuQWNjZXNzS2V5SUQpO1xuICBjb3JlLmV4cG9ydFZhcmlhYmxlKCdBV1NfU0VDUkVUX0FDQ0VTU19LRVknLCBpbnB1dHMuU2VjcmV0QWNjZXNzS2V5KTtcbiAgY29yZS5leHBvcnRWYXJpYWJsZSgnQVdTX0RFRkFVTFRfUkVHSU9OJywgaW5wdXRzLlJlZ2lvbik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGF3c0VjckxvZ2luKGlucHV0czogSW5wdXRzKSB7XG4gIGNvcmUuaW5mbygnPT0gTE9HSU4gSU5UTyBBV1MgRUNSID09JylcblxuICBsZXQgbG9naW5DbWQgPSAnJztcbiAgbGV0IGVyciA9ICcnO1xuXG4gIGxldCBvcHRzOiBFeGVjT3B0aW9ucyA9IHtcbiAgICBjd2Q6ICcuLycsXG4gICAgc2lsZW50OiB0cnVlLFxuICAgIGxpc3RlbmVyczoge1xuICAgICAgc3Rkb3V0OiAoZGF0YTogQnVmZmVyKSA9PiB7XG4gICAgICAgIGxvZ2luQ21kICs9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgIH0sXG4gICAgICBzdGRlcnI6IChkYXRhOiBCdWZmZXIpID0+IHtcbiAgICAgICAgZXJyICs9IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgIH1cbiAgICB9LFxuICB9XG5cbiAgYXdhaXQgZXhlYyhgYXdzIGVjciBnZXQtbG9naW4gLS1uby1pbmNsdWRlLWVtYWlsIC0tcmVnaW9uICR7aW5wdXRzLlJlZ2lvbn1gLCB1bmRlZmluZWQsIG9wdHMpO1xuICBpZiAoZXJyLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byByZXRyaWV2ZSBkb2NrZXIgbG9naW4gdG8gQVdTIEVDUi4gUGVyaGFwcyB0aGUgQVdTIGNyZWRlbnRpYWxzIGRvIG5vdCBoYXZlIHRoZSBjb3JyZWN0IHBlcm1pc3Npb24nKTtcbiAgfVxuXG4gIGF3YWl0IGV4ZWMobG9naW5DbWQsIHVuZGVmaW5lZCwgb3B0cyk7XG5cbiAgY29yZS5pbmZvKCc9PSBGSU5JU0hFRCBMT0dJTiA9PScpO1xufVxuXG5mdW5jdGlvbiBnZXRFY3JSZXBvTmFtZShpbnB1dHM6IElucHV0cyk6IHN0cmluZyB7XG4gIGlmIChpbnB1dHMuRWNyUmVwb05hbWUubGVuZ3RoID4gMCkge1xuICAgIHJldHVybiBpbnB1dHMuRWNyUmVwb05hbWU7XG4gIH1cblxuICAvLyBkZWZhdWx0XG4gIHJldHVybiAocHJvY2Vzcy5lbnYuR0lUSFVCX1JFUE9TSVRPUlkgfHwgJycpLnRvTG9jYWxlTG93ZXJDYXNlKClcbn1cblxuZnVuY3Rpb24gZ2V0RWNyVGFncyhhY2NvdW50VXJsOiBzdHJpbmcsIHJlcG9OYW1lOiBzdHJpbmcsIGlucHV0VGFnczogc3RyaW5nKTogc3RyaW5nW10ge1xuICBsZXQgdGFncyA9IGlucHV0VGFncy5zcGxpdCgnLCcpO1xuICBjb25zdCBlY3JUYWdzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIC8vIEFkZCB0aGUgcmVmIHRhZyBpZiBjb2RlIGlzIGEgY2hlY2tlZCBvdXQgcmVsZWFzZSB0YWdcbiAgaWYgKChwcm9jZXNzLmVudi5HSVRIVUJfUkVGIHx8ICcnKS5zdGFydHNXaXRoKCdyZWZzL3RhZ3MnKSkge1xuICAgIGNvbnN0IHRhZyA9IChwcm9jZXNzLmVudi5HSVRIVUJfUkVGIHx8ICcnKS5zcGxpdCgnLycpLnBvcCgpO1xuXG4gICAgaWYgKHRhZyAhPT0gJycgfHwgdGFnICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGVjclRhZ3MucHVzaChgJHthY2NvdW50VXJsfS8ke3JlcG9OYW1lfToke3RhZ31gKTtcbiAgICB9XG4gIH1cblxuICAvLyBCdWlsZCB0aGUgdGFnc1xuICBmb3IgKGNvbnN0IHRhZyBvZiB0YWdzKSB7XG4gICAgZWNyVGFncy5wdXNoKGAke2FjY291bnRVcmx9LyR7cmVwb05hbWV9OiR7dGFnfWApO1xuICB9XG5cbiAgcmV0dXJuIGVjclRhZ3Ncbn1cblxuYXN5bmMgZnVuY3Rpb24gYXdzQ3JlYXRlRWNyUmVwbyhpbnB1dHM6IElucHV0cykge1xuICBjb3JlLmluZm8oJz09IENIRUNLSU5HIEZPUiBFQ1IgUkVQTyA9PScpO1xuXG4gIGNvbnN0IHJlcG9OYW1lID0gZ2V0RWNyUmVwb05hbWUoaW5wdXRzKTtcblxuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoYGF3cyBlY3IgZGVzY3JpYmUtcmVwb3NpdG9yaWVzIC0tcmVwb3NpdG9yeS1uYW1lcyBcIiR7cmVwb05hbWV9XCJgKTtcbiAgfSBjYXRjaCB7XG4gICAgLy8gUmVwbyBkb2Vzbid0IGV4aXN0IG9yIGZhaWxlZC4gVHJ5IGNyZWF0aW5nIGlmIHNwZWNpZmllZC5cbiAgICBpZiAoaW5wdXRzLlNob3VsZENyZWF0ZVJlcG8gPT09ICd0cnVlJykge1xuICAgICAgY29yZS5pbmZvKCc9PSBDUkVBVElORyBFQ1IgUkVQTyA9PScpO1xuICAgICAgYXdhaXQgZXhlYyhgYXdzIGVjciBjcmVhdGUtcmVwb3NpdG9yeSAtLXJlcG9zaXRvcnktbmFtZSAke3JlcG9OYW1lfWApO1xuICAgICAgY29yZS5pbmZvKGA9PSBGSU5JU0hFRCBDUkVBVElORyBFQ1IgUkVQTyBbICR7cmVwb05hbWV9IF0gPT1gKTtcbiAgICAgIHJldHVyblxuICAgIH0gZWxzZSB7XG4gICAgICBjb3JlLnNldEZhaWxlZCgnPT0gRUNSIFJlcG9zaXRvcnkgaXMgbWlzc2luZyA9PScpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFQ1IgcmVwbyBuYW1lZCBbICR7cmVwb05hbWV9IF0gd2FzIG5vdCBmb3VuZC4gUGVyaGFwcyB0aGUgc3BlbGxpbmcgd2FzIGluY29ycmVjdD9gKTtcbiAgICB9XG4gIH1cblxuICBjb3JlLmluZm8oJz09IFJFUE8gRk9VTkQgPT0nKVxufVxuXG5hc3luYyBmdW5jdGlvbiBidWlsZEltYWdlKGlucHV0czogSW5wdXRzLCBhY2NvdW50VXJsOiBzdHJpbmcpIHtcbiAgY29yZS5pbmZvKCc9PSBCVUlMRCBJTUFHRSBGUk9NIERPQ0tFUkZJTEUgPT0nKTtcbiAgY29uc3QgcmVwb05hbWUgPSBnZXRFY3JSZXBvTmFtZShpbnB1dHMpO1xuICBjb25zdCBlY3JUYWdzID0gZ2V0RWNyVGFncyhhY2NvdW50VXJsLCByZXBvTmFtZSwgaW5wdXRzLkVjclRhZ3MpO1xuXG4gIGxldCB0YWdzID0gZWNyVGFncy5qb2luKCcgLXQgJyk7XG5cbiAgaWYgKHRhZ3MubGVuZ3RoID4gMCkge1xuICAgIHRhZ3MgPSBgLXQgJHt0YWdzfWBcbiAgfVxuXG5cbiAgYXdhaXQgZXhlYyhgZG9ja2VyIGJ1aWxkICR7aW5wdXRzLkRvY2tlckJ1aWxkQXJnc30gLWYgJHtpbnB1dHMuRG9ja2VyZmlsZVBhdGh9ICR7dGFnc30gLmAsIHVuZGVmaW5lZCwge1xuICAgIGN3ZDogaW5wdXRzLlByb2plY3RQYXRoLFxuICB9KTtcbiAgY29yZS5pbmZvKCc9PSBGSU5JU0hFRCBCVUlMRElORyBJTUFHRSA9PScpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZXBsb3lUb0VjcihpbnB1dHM6IElucHV0cywgYWNjb3VudFVybDogc3RyaW5nKSB7XG4gIGNvcmUuaW5mbygnPT0gREVQTE9ZSU5HIFRPIEVDUiA9PScpO1xuICBjb3JlLmRlYnVnKGA6OiBFQ1IgQWNjb3VudCBVUkw6ICR7YWNjb3VudFVybH1gKTtcblxuICBjb25zdCByZXBvTmFtZSA9IGdldEVjclJlcG9OYW1lKGlucHV0cyk7XG4gIGNvbnN0IGVjclRhZ3MgPSBnZXRFY3JUYWdzKGFjY291bnRVcmwsIHJlcG9OYW1lLCBpbnB1dHMuRWNyVGFncyk7XG5cbiAgZm9yIChjb25zdCB0YWcgb2YgZWNyVGFncykge1xuICAgIGF3YWl0IGV4ZWMoYGRvY2tlciBwdXNoICR7dGFnfWApO1xuICB9XG5cbiAgY29yZS5pbmZvKCc9PSBGSU5JU0hFRCBERVBMT1lNRU5UID09Jyk7XG59XG5cbnRyeSB7XG4gIHJ1bigpO1xufSBjYXRjaCAoZXJyb3IpIHtcbiAgY29yZS5lcnJvcihlcnJvcik7XG4gIGNvcmUuc2V0RmFpbGVkKGVycm9yLm1lc3NhZ2UpO1xufSJdfQ==